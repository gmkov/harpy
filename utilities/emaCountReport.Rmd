---
title: "Barcode Validation Summary"
author:
    - "Created using HARPY"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    highlight: tango
    number_sections: no
    theme: cosmo
    df_print: kable
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: no
      smooth_scroll: yes
---
  
```{r echo = FALSE, message = FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(magrittr)
library(DT)
library(plotly)
```

## Barcode validity
Below is a table listing all the samples Harpy processed and their associated barcode statistics as
determined by `EMA count`. If `BarcodeTotal` equals `0` for some reason, then there is an issue
with the format of your FASTQ files. Please check that the barcode in the read headers comforms 
to the correct format, `BX:Z:AXXCXXBXXDXX`, where there is a whitespace/tab before `BX:Z:` and `XX` are
2-digit numbers between `00` and `96`. A valid FASTQ read header would then look like
```
@A00470:481:HNYFWDRX2:1:2101:16062:1031 BX:Z:A62C38B38D96 1:N:0:TATCAGTA+TTACTACT
```

```{r echo = FALSE, message = FALSE, warning = FALSE}
BXstats <- data.frame(
            Sample=character(),
            ReadsIgnored=integer(),
            BarcodeValid=integer(),
            BarcodeTotal=integer(),
            PercentValid=numeric()
)

#for (i in list.files("/home/pdimens", "count.log", full.names = TRUE)) {
for (i in snakemake@input[["countlog"]]) {
  samplename <- gsub(".count.log", "", basename(i))
  filetext <- readLines(i)
  bc_line <- gsub(",", "", filetext[2])
  matches <- gregexpr('[0-9]+', bc_line)
  counts <- as.numeric(unlist(regmatches(bc_line, matches)))
  bc_ok <- counts[1]
  bc_total <- counts[2]
  if (bc_total == 0) {
    bc_percent <- 0
  } else {
    bc_percent <- trunc((bc_ok / bc_total) * 10000) / 100
  }
  ignored <- as.numeric(gsub("[^0-9]", "", filetext[3]))

  BXstats <- rbind(BXstats, data.frame(Sample = samplename, ReadsIgnored = ignored, BarcodeValid = bc_ok, BarcodeTotal = bc_total, PercentValid = bc_percent))
}
DT::datatable(BXstats, rownames = F, filter = "top", extensions = 'Buttons', options = list(dom = 'Brtip', buttons = c('csv', 'pdf'), scrollX = TRUE))
```

Below is a table summarizing the number of valid vs invalid barcodes per sample.
```{r echo = FALSE, message = FALSE, warning = FALSE, out.width = '100%'}
p <- BXstats %>% 
  mutate(Invalid = BarcodeTotal - BarcodeValid) %>% 
  rename(Valid = BarcodeValid) %>% 
  select(Sample, Valid, Invalid) %>% 
  pivot_longer(-Sample, names_to = "BarcodeStatus", values_to = "Count") %>%
  ggplot(aes(x = Sample, y = Count, fill = BarcodeStatus)) +
    geom_col() +
    theme_minimal() +
    theme(
      panel.grid.major.x = element_blank(),
      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)
    ) +
    scale_fill_manual(values = c(Valid = "#afd5e7", Invalid = "#aa6f73")) +
  labs(title = "Summary of Valid Barcodes") 

plt <- ggplotly(p) %>% layout(hovermode = "x")
plt
```