---
title: "BX Bardcode Summary"
author:
    - "Created using HARPY"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    highlight: tango
    number_sections: no
    theme: cosmo
    df_print: kable
    toc: no
---
  
```{r echo = FALSE, message = FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(scales)
library(magrittr)
library(DT)
library(plotly)
```
## Barcode Validation {.tabset}
This report details the counts of valid and invalid haplotag barcodes in the sample read headers.
The correct haplotag format is `BX:Z:AXXCXXBXXDXX`, where there is a whitespace/tab before `BX:Z:` 
and `XX` are 2-digit numbers between `00` and `96`. A valid FASTQ read header would then look like:
```
@A00814:267:HTMH3DRXX:2:1101:4580:1000 BX:Z:A02C01B11D46        RX:Z:GAAACGACCAACA+CGAACACGTTAGC   QX:Z:F,FFFFFFFFFFF+FF,FFF:FFFFFF
```
Notably, only the sequence ID (`@...`) and `BX:Z:` tag are required. In the example above, there are additional tags 
(`RX:Z:` and `QX:Z:`) which arent used by Harpy, but they conform to the 
[SAM comment spec (section 1.5)](https://samtools.github.io/hts-specs/SAMv1.pdf) of `TAG:TYPE:VALUE`. The takeaway 
is that the `BX:Z` tag can be anywhere in the read header after the sequence ID as long as any tags after it conform to the SAM spec `TAG:TYPE:VALUE`. 

### Table
Below is a table listing all the samples Harpy processed and their associated barcode statistics as
determined by `EMA count`. If `BarcodeTotal` equals `0` for some reason, then there may be an issue
with the format of your FASTQ headers.

```{r echo = FALSE, message = FALSE, warning = FALSE}
BXstats <- data.frame(
  Sample = character(),
  ReadsIgnored = integer(),
  BarcodeValid = integer(),
  BarcodeTotal = integer(),
  PercentValid = numeric(),
  PercentIgnored = numeric()
)

#for (i in list.files("/home/pdimens", "count.log", full.names = TRUE)) {
for (i in snakemake@input[["countlog"]]) {
  samplename <- gsub(".count.log", "", basename(i))
  filetext <- readLines(i)
  bc_line <- gsub(",", "", filetext[2])
  matches <- gregexpr("[0-9]+", bc_line)
  counts <- as.numeric(unlist(regmatches(bc_line, matches)))
  bc_ok <- counts[1]
  bc_total <- counts[2]
  ignored <- as.numeric(gsub("[^0-9]", "", filetext[3]))
  if (bc_total == 0) {
    bc_percent <- 0
    ig_percent <- 0
  } else {
    bc_percent <- trunc((bc_ok / bc_total) * 10000) / 100
    ig_percent <- trunc((ignored / bc_total) * 10000) / 100
  }

  BXstats <- rbind(
    BXstats,
    data.frame(
      Sample = samplename,
      ReadsIgnored = ignored,
      BarcodeValid = bc_ok,
      BarcodeTotal = bc_total,
      PercentValid = bc_percent,
      PercentIgnored = ig_percent)
  )
}
DT::datatable(
  BXstats,
  rownames = FALSE,
  filter = "top",
  extensions = "Buttons",
  options = list(
    dom = "Brtip",
    buttons = c("csv"),
    scrollX = TRUE
  )
)
```

### Per Sample Plot
Below is a plot summarizing the number of valid vs invalid barcodes per sample.

```{r echo = FALSE, message = FALSE, warning = FALSE}
plotdata <- BXstats %>%
  mutate(Invalid = BarcodeTotal - BarcodeValid) %>%
  rename(Valid = BarcodeValid) %>%
  select(Sample, Valid, Invalid)

percdata <- BXstats %>%
  mutate(Valid = round(BarcodeValid / BarcodeTotal * 100, 2)) %>%
  mutate(Invalid = 100.0 - Valid) %>%
  select(Sample, Valid, Invalid)

pltheight <- 50 * length(unique(plotdata$Sample))
```

```{r echo = FALSE, message = FALSE, warning = FALSE, out.width = '100%'}
p <-  plotdata %>%
  pivot_longer(-Sample, names_to = "BarcodeStatus", values_to = "Count") %>%
  ggplot(aes(y = Sample, x = Count, fill = BarcodeStatus)) +
    geom_col() +
    theme_minimal() +
    theme(panel.grid.major.y = element_blank(), axis.title.y = element_blank()) +
    scale_fill_manual(values = c(Valid = "#afd5e7", Invalid = "#c02554")) +
    scale_x_continuous(labels = scales::comma) +
    labs(title = "Summary of Valid Barcodes")

ggplotly(p, height = pltheight)
```

### % Per Sample Plot
Below is a plot summarizing the number of valid vs invalid barcodes per sample as a percentage
of the total reads for that sample.

```{r echo = FALSE, message = FALSE, warning = FALSE, out.width = '100%'}
pc <- percdata %>%
  pivot_longer(-Sample, names_to = "BarcodeStatus", values_to = "Percent") %>%
  ggplot(aes(y = Sample, x = Percent, fill = BarcodeStatus)) +
    geom_col() +
    theme_minimal() +
    theme(panel.grid.major.y = element_blank(), axis.title.y = element_blank()) +
    scale_fill_manual(values = c(Valid = "#afd5e7", Invalid = "#c02554")) +
    xlim(0, 100) +
    scale_x_continuous(labels = scales::comma) +
    labs(title = "Summary of Valid Barcodes")

ggplotly(pc, height = pltheight)
```