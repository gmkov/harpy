---
title: "Haplotag QC Bardcode Summary"
date: "`r format(Sys.time(), '%m-%d-%y %X')`"
output:
  flexdashboard::flex_dashboard:
    theme: lumen
    orientation: columns
    vertical_layout: scroll
    favicon: "https://raw.githubusercontent.com/pdimens/harpy/docs/static/favicon.png"
---

```{r echo = FALSE, message = FALSE}
library(flexdashboard)
library(dplyr)
library(tidyr)
library(ggplot2)
library(scales)
library(magrittr)
library(DT)
library(plotly)
```

This report details the counts of valid and invalid haplotag barcodes in the 
sample read headers. The correct haplotag format is `BX:Z:AXXCXXBXXDXX`, where 
there is a whitespace/tab before `BX:Z:` and `XX` are 2-digit numbers between
`00` and `96`. A valid FASTQ read header would then look like:

```         
@A00814:267:HTMH3DRXX:2:1101:4580:1000 BX:Z:A02C01B11D46        RX:Z:GAAACGACCAACA+CGAACACGTTAGC   QX:Z:F,FFFFFFFFFFF+FF,FFF:FFFFFF
```

Notably, only the sequence ID (`@...`) and `BX:Z:` tag are required. In the example above, there are additional tags (`RX:Z:` and `QX:Z:`) which arent used by Harpy, but they conform to the [SAM comment spec (section 1.5)](https://samtools.github.io/hts-specs/SAMv1.pdf) of `TAG:TYPE:VALUE`. The takeaway is that the `BX:Z` tag can be anywhere in the read header after the sequence ID as long as any tags after it conform to the SAM spec `TAG:TYPE:VALUE`.


```{r echo = FALSE, message = FALSE, warning = FALSE}
BXstats <- data.frame(
  Sample = character(),
  TotalReads = integer(),
  BarcodePresent = integer(),
  ValidBarcodes = integer(),
  ValidPercent = numeric(),
  InvalidBarcodes = integer(),
  InvalidPercent = numeric()
)

invalids <- data.frame(
  Sample = character(),
  A = integer(),
  C = integer(),
  B = integer(),
  D = integer()
)

for (i in list.files("~/Documents/harpy/test/QC/logs/bxcount/", ".count.log", full.names = TRUE)) {
#for (i in snakemake@input[["countlog"]]) {
  samplename <- gsub(".count.log", "", basename(i))
  s_df <- read.table(i, header = F)
  total <- s_df$V2[1]
  bc_total <- s_df$V2[2]
  bc_ok <- s_df$V2[3]
  bc_invalid <- s_df$V2[4]
  if (bc_total == 0) {
    bc_percent <- 0
    ig_percent <- 0
  } else {
    bc_percent <- trunc((bc_ok / bc_total) * 10000) / 100
    ig_percent <- trunc((bc_invalid / bc_total) * 10000) / 100
  }

  BXstats <- rbind(
    BXstats,
    data.frame(
      Sample = samplename,
      TotalReads = total,
      BarcodePresent = bc_total,
      ValidBarcodes = bc_ok,
      ValidPercent = bc_percent,
      BarcodeInvalid = bc_invalid,
      PercentInvalid = ig_percent
      )
  )
  invalids <- rbind(
    invalids,
    data.frame(
      Sample = samplename,
      A = s_df$V2[5],
      C = s_df$V2[6],
      B = s_df$V2[7],
      D = s_df$V2[8]
    )
  )
}
```


## genstats {data-height=100}
### filerow {.no-title}
```{r}
valueBox(scales::comma(nrow(BXstats)), caption = "Samples", color = "success")
```
### mininv {.no-title}
```{r}
valueBox(min(BXstats$ValidPercent), caption = "Min Percent Valid", color = "info")
```
### maxinv {.no-title}
```{r}
valueBox(max(BXstats$ValidPercent), caption = "Max Percent Valid", color = "info")
```

### minign {.no-title}
```{r}
absent <- BXstats$TotalReads-BXstats$BarcodePresent
valueBox(min(absent), caption = "Min Absent Barcodes", color = "info")
```
### maxign {.no-title}
```{r}
valueBox(max(absent), caption = "Max Absent Barcodes", color = "info")
```


### Per Sample Plot

Below is a plot summarizing the number of valid vs invalid barcodes per sample.

```{r echo = FALSE, message = FALSE, warning = FALSE}
plotdata <- BXstats %>%
  select(Sample, ValidBarcodes, BarcodeInvalid) %>% 
  rename(Valid = ValidBarcodes, Invalid = BarcodeInvalid)

percdata <- BXstats %>%
  select(Sample, ValidPercent, PercentInvalid) %>% 
  rename(Valid= ValidPercent, Invalid = PercentInvalid)

pltheight <- 150 + (30 * length(unique(plotdata$Sample)))
```

```{r echo = FALSE, message = FALSE, warning = FALSE, out.width = '100%'}
p <-  plotdata %>%
  pivot_longer(-Sample, names_to = "Barcode", values_to = "Count") %>%
  ggplot(aes(y = Sample, x = Count, fill = Barcode)) +
    geom_col() +
    theme_minimal() +
    theme(panel.grid.major.y = element_blank(), axis.title.y = element_blank()) +
    scale_fill_manual(values = c(Valid = "#afd5e7", Invalid = "#c02554")) +
    scale_x_continuous(labels = scales::comma) +
    labs(title = "Valid vs Invalid Barcodes")

ggplotly(p, height = pltheight)
```

### Table {.no-title}

Below is a table listing all the samples Harpy processed and their associated barcode statistics as determined by the reads in the **forward read only**. If `TotalBarcodes` equals `0` for some reason, then there may be an issue with the format of your FASTQ headers.

```{r}
DT::datatable(
  BXstats,
  rownames = FALSE,
  filter = "top",
  extensions = "Buttons",
  options = list(
    dom = "Brtip",
    buttons = c("csv"),
    scrollX = TRUE
  )
)
```

### Invalid by Segment

This table details the count of invalid beadtag segments across all **forward reads** within a sample. This can help you diagnose if any beadtag segments in your experimental design have a higher incidence of failure than others.

```{r echo = FALSE, message = FALSE, warning = FALSE}
DT::datatable(
  invalids,
  rownames = FALSE,
  extensions = "Buttons",
  options = list(
    dom = "Brtip",
    buttons = c("csv"),
    scrollX = TRUE
  )
)
```
